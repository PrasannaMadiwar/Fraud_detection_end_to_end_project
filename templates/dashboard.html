<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraud Detection Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            background: #0f172a; 
            color: white; 
            font-family: 'Segoe UI', sans-serif; 
        }
        .card { 
            background: #1e293b; 
            border-radius: 1rem; 
            padding: 1.5rem; 
            margin-bottom: 2rem; 
            border: 1px solid #374151;
        }
        .sidebar { 
            background: #111827; 
            min-height: 100vh; 
            padding: 2rem; 
            width: 16rem; 
            position: fixed; 
            border-right: 1px solid #374151;
        }
        .sidebar a { 
            display: block; 
            padding: 1rem 0; 
            color: white; 
            text-decoration: none; 
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            padding-left: 1rem;
        }
        .sidebar a:hover { 
            color: #6366f1; 
            background: #1e293b;
        }
        .main { 
            margin-left: 16rem; 
            padding: 2rem; 
        }
        .result-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
        }
        .fraud-badge { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .legit-badge { background: rgba(34, 197, 94, 0.2); color: #86efac; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2 class="text-2xl font-bold mb-8 text-indigo-400">
            <i class="fas fa-shield-alt mr-2"></i>Dashboard
        </h2>
        <a href="#prediction"><i class="fas fa-chart-pie mr-2"></i>Prediction Result</a>
        <a href="#shap"><i class="fas fa-brain mr-2"></i>SHAP Analysis</a>
        <a href="#chart"><i class="fas fa-bar-chart mr-2"></i>Feature Impact</a>
        <a href="/"><i class="fas fa-plus mr-2"></i>New Prediction</a>
    </div>
    
    <div class="main">
        <h1 class="text-4xl font-bold mb-6 text-center">
            <i class="fas fa-analytics mr-3 text-indigo-400"></i>
            Fraud Detection Results
        </h1>

        <!-- Prediction Result -->
        <div id="prediction" class="card">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-400">
                <i class="fas fa-shield-alt mr-2"></i>Prediction Result
            </h2>
            <div class="bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-lg text-gray-300 mb-2">Transaction Status:</p>
                        <span class="result-badge {% if prediction == 'Fraudulent' %}fraud-badge{% else %}legit-badge{% endif %}">
                            <i class="fas {% if prediction == 'Fraudulent' %}fa-exclamation-triangle{% else %}fa-check-circle{% endif %} mr-2"></i>
                            {{ prediction }}
                        </span>
                    </div>
                    <div class="text-right">
                        <p class="text-lg text-gray-300 mb-2">Fraud Probability:</p>
                        <span class="text-3xl font-bold text-yellow-400">{{ probability }}%</span>
                    </div>
                </div>
                
                <!-- Risk Level Indicator -->
                <div class="mt-4">
                    <p class="text-sm text-gray-400 mb-2">Risk Level:</p>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="bg-gradient-to-r {% if probability > 50 %}from-red-500 to-red-600{% else %}from-green-500 to-green-600{% endif %} h-2 rounded-full" 
                             style="width: {{ probability }}%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SHAP Explanation -->
        <div id="shap" class="card">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-400">
                <i class="fas fa-brain mr-2"></i>SHAP Explainability Analysis
            </h2>
            <p class="text-gray-300 mb-4">
                <i class="fas fa-info-circle mr-1 text-blue-400"></i>
                AI model decision explanation showing feature contributions:
            </p>
            <div class="bg-white p-4 rounded-lg">
                {% if shap_img %}
                    <img src="{{ url_for('static', filename=shap_img) }}" 
                         alt="SHAP Plot" 
                         class="w-full h-auto rounded">
                {% else %}
                    <p class="text-center text-gray-600 py-8">SHAP plot will appear here after analysis</p>
                {% endif %}
            </div>
        </div>

        <!-- Feature Impact Chart -->
        <div id="chart" class="card">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-400">
                <i class="fas fa-chart-bar mr-2"></i>All Features Impact Analysis
            </h2>
            <p class="text-gray-300 mb-4">
                <i class="fas fa-chart-line mr-1 text-green-400"></i>
                Complete breakdown of all 29 feature contributions (V1-V28 + Amount):
            </p>
            <div class="bg-gray-800 p-4 rounded-lg" style="height: 500px;">
                <canvas id="featureChart"></canvas>
            </div>
        </div>

        <!-- Technical Details -->
        <div class="card">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-400">
                <i class="fas fa-cogs mr-2"></i>Technical Details
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-gray-800 p-4 rounded-lg text-center">
                    <i class="fas fa-robot text-2xl text-blue-400 mb-2"></i>
                    <p class="text-sm text-gray-400">Model</p>
                    <p class="font-semibold">XGBoost</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg text-center">
                    <i class="fas fa-layer-group text-2xl text-purple-400 mb-2"></i>
                    <p class="text-sm text-gray-400">Features</p>
                    <p class="font-semibold">29 Dimensions</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg text-center">
                    <i class="fas fa-eye text-2xl text-green-400 mb-2"></i>
                    <p class="text-sm text-gray-400">Explainability</p>
                    <p class="font-semibold">SHAP Values</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg text-center">
                    <i class="fas fa-shield-alt text-2xl text-red-400 mb-2"></i>
                    <p class="text-sm text-gray-400">Security</p>
                    <p class="font-semibold">Enterprise</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get template data with proper fallbacks
        var featureNames = {{ feature_names|default([])|tojson|safe }};
        var featureValues = {{ feature_values|default([])|tojson|safe }};
        
        console.log('Feature Names:', featureNames.length, 'items');
        console.log('Feature Values:', featureValues.length, 'items');
        
        // Create chart only if we have data
        if (featureNames && featureValues && featureNames.length > 0 && featureValues.length > 0) {
            const ctx = document.getElementById('featureChart').getContext('2d');
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: featureNames,
                    datasets: [{
                        label: 'Feature Impact (|SHAP Values|)',
                        data: featureValues,
                        backgroundColor: 'rgba(99, 102, 241, 0.7)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.9)',
                            titleColor: 'white',
                            bodyColor: 'white'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Impact Magnitude',
                                color: 'white'
                            },
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Features',
                                color: 'white'
                            },
                            ticks: {
                                color: 'white',
                                maxRotation: 90,
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        } else {
            document.getElementById('featureChart').parentElement.innerHTML = 
                '<p class="text-center text-gray-400 mt-8"><i class="fas fa-chart-bar mr-2"></i>Chart will appear after making a prediction</p>';
        }

        // Add smooth scroll for navigation links
        document.querySelectorAll('.sidebar a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>
</body>
</html>